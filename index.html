<!-- Ecoshane Lex 聊天機器人 - 直接嵌入代碼 -->
<style>
/* 聊天機器人樣式 */
.ecoshane-chatbot {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.chat-toggle-btn {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #28a745, #20c997);
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    transition: all 0.3s ease;
    position: relative;
}

.chat-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(40, 167, 69, 0.6);
}

.chat-toggle-btn.active {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
}

.chat-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 350px;
    height: 500px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s ease-out;
    border: 1px solid #e0e0e0;
}

.chat-window.active {
    display: flex;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.chat-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.chat-avatar {
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
}

.chat-info h4 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chat-info p {
    margin: 2px 0 0 0;
    font-size: 12px;
    opacity: 0.9;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.4;
    animation: fadeIn 0.4s ease-in;
    word-wrap: break-word;
}

.message.bot {
    background: white;
    color: #333;
    align-self: flex-start;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-bottom-left-radius: 4px;
}

.message.user {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-input {
    padding: 15px;
    background: white;
    border-top: 1px solid #e9ecef;
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.input-field {
    flex: 1;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    padding: 12px 18px;
    font-size: 14px;
    outline: none;
    resize: none;
    max-height: 80px;
    min-height: 44px;
    font-family: inherit;
    transition: border-color 0.3s;
    background: #fff;
}

.input-field:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.send-btn {
    width: 44px;
    height: 44px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    font-size: 16px;
}

.send-btn:hover {
    background: #218838;
    transform: scale(1.05);
}

.send-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.typing-indicator {
    display: none;
    padding: 12px 16px;
    background: white;
    border-radius: 18px;
    align-self: flex-start;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-bottom-left-radius: 4px;
}

.typing-indicator.active {
    display: flex;
    align-items: center;
    gap: 4px;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #28a745;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { 
        transform: translateY(0);
        opacity: 0.4;
    }
    30% { 
        transform: translateY(-10px);
        opacity: 1;
    }
}

.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    display: none;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
    border: 2px solid white;
}

.notification-badge.show {
    display: flex;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* 響應式設計 */
@media (max-width: 480px) {
    .chat-window {
        width: calc(100vw - 40px);
        height: 70vh;
        bottom: 80px;
        right: 20px;
        left: 20px;
    }
    
    .ecoshane-chatbot {
        right: 20px;
        bottom: 20px;
    }
}

/* 錯誤狀態 */
.error-message {
    background: #f8d7da !important;
    color: #721c24 !important;
    border: 1px solid #f5c6cb;
}

/* 連接狀態指示 */
.connection-status {
    padding: 8px 15px;
    background: #d4edda;
    color: #155724;
    font-size: 12px;
    text-align: center;
    border-bottom: 1px solid #c3e6cb;
}

.connection-status.error {
    background: #f8d7da;
    color: #721c24;
    border-bottom-color: #f5c6cb;
}
</style>

<!-- 聊天機器人 HTML -->
<div class="ecoshane-chatbot">
    <!-- 通知徽章 -->
    <div class="notification-badge" id="notificationBadge">1</div>
    
    <!-- 切換按鈕 -->
    <button class="chat-toggle-btn" id="chatToggleBtn" title="Eco 智能助手">
        <span id="chatIcon">🌱</span>
    </button>
    
    <!-- 聊天窗口 -->
    <div class="chat-window" id="chatWindow">
        <!-- 頭部 -->
        <div class="chat-header">
            <div class="chat-avatar">🌱</div>
            <div class="chat-info">
                <h4>Eco 智能助手</h4>
                <p>Ecoshane 永續顧問</p>
            </div>
        </div>
        
        <!-- 連接狀態 -->
        <div class="connection-status" id="connectionStatus">
            正在連接...
        </div>
        
        <!-- 訊息區域 -->
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                您好！我是 Ecoshane 的 Eco 智能助手 🌿<br><br>
                我可以協助您了解：<br>
                • 企業永續發展服務<br>
                • 碳足跡評估與減碳策略<br>
                • ESG 報告與諮詢<br>
                • 綠色轉型規劃<br><br>
                有什麼可以幫助您的嗎？
            </div>
        </div>
        
        <!-- 打字指示器 -->
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
        
        <!-- 輸入區域 -->
        <div class="chat-input">
            <textarea 
                class="input-field" 
                id="messageInput" 
                placeholder="請輸入您的問題..."
                rows="1"
                maxlength="1000"
            ></textarea>
            <button class="send-btn" id="sendBtn" title="發送訊息">
                ➤
            </button>
        </div>
    </div>
</div>

<!-- AWS SDK -->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1691.0.min.js"></script>

<script>
// Ecoshane Lex 聊天機器人類
class EcoshaneLexChatbot {
    constructor() {
        // ⭐ 請在這裡設定你的 AWS Lex 機器人資訊
        this.config = {
            region: 'us-east-1',                    // 你的 AWS 區域
            botName: 'example',               // 你的 Lex 機器人名稱
            botAlias: 'TestBotAlias',             // 你的機器人別名 (通常是 '$LATEST')
            identityPoolId: 'us-east-1:05eec0e5-0c38-45a1-8a36-729ffb25c03d' // 你的 Cognito Identity Pool ID
        };
        
        this.isOpen = false;
        this.isTyping = false;
        this.sessionId = `ecoshane-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        
        this.initElements();
        this.bindEvents();
        this.setupAWS();
    }
    
    initElements() {
        this.toggleBtn = document.getElementById('chatToggleBtn');
        this.chatWindow = document.getElementById('chatWindow');
        this.chatMessages = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendBtn = document.getElementById('sendBtn');
        this.chatIcon = document.getElementById('chatIcon');
        this.typingIndicator = document.getElementById('typingIndicator');
        this.notificationBadge = document.getElementById('notificationBadge');
        this.connectionStatus = document.getElementById('connectionStatus');
    }
    
    bindEvents() {
        this.toggleBtn.addEventListener('click', () => this.toggleChat());
        this.sendBtn.addEventListener('click', () => this.handleSendMessage());
        
        this.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendMessage();
            }
        });
        
        // 自動調整輸入框高度
        this.messageInput.addEventListener('input', (e) => {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 80) + 'px';
        });
        
        // 點擊外部關閉聊天窗口
        document.addEventListener('click', (e) => {
            if (this.isOpen && !this.chatWindow.contains(e.target) && !this.toggleBtn.contains(e.target)) {
                this.toggleChat();
            }
        });
    }
    
    setupAWS() {
        // 檢查是否已設定機器人資訊
        if (this.config.botName === 'YOUR_BOT_NAME') {
            this.showConnectionStatus('請先設定 AWS Lex 機器人資訊', true);
            return;
        }
        
        try {
            // 設定 AWS 
            AWS.config.region = this.config.region;
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: this.config.identityPoolId
            });
            
            // 建立 Lex Runtime 服務
            this.lexRuntime = new AWS.LexRuntime();
            
            this.showConnectionStatus('已連接到 Lex 機器人');
            
            // 3秒後隱藏狀態
            setTimeout(() => {
                this.connectionStatus.style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('AWS 設定錯誤:', error);
            this.showConnectionStatus('連接失敗，請檢查設定', true);
        }
    }
    
    showConnectionStatus(message, isError = false) {
        this.connectionStatus.textContent = message;
        this.connectionStatus.classList.toggle('error', isError);
    }
    
    toggleChat() {
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            this.chatWindow.classList.add('active');
            this.toggleBtn.classList.add('active');
            this.chatIcon.textContent = '✕';
            this.messageInput.focus();
            this.hideNotification();
        } else {
            this.chatWindow.classList.remove('active');
            this.toggleBtn.classList.remove('active');
            this.chatIcon.textContent = '🌱';
        }
    }
    
    async handleSendMessage() {
        const message = this.messageInput.value.trim();
        
        if (!message || this.isTyping) return;
        
        // 顯示用戶訊息
        this.addMessage(message, true);
        this.clearInput();
        
        // 顯示打字指示器
        this.showTyping();
        
        try {
            let response;
            
            if (this.lexRuntime && this.config.botName !== 'YOUR_BOT_NAME') {
                // 使用 AWS Lex
                response = await this.sendToLex(message);
            } else {
                // 使用預設回覆（當未設定 Lex 時）
                response = await this.getDefaultResponse(message);
            }
            
            // 顯示機器人回覆
            this.hideTyping();
            this.addMessage(response);
            
        } catch (error) {
            console.error('發送訊息錯誤:', error);
            this.hideTyping();
            this.addMessage('抱歉，目前服務暫時無法使用，請稍後再試或直接聯繫我們：contact@ecoshane.com', false, true);
        }
    }
    
    async sendToLex(message) {
        const params = {
            botName: this.config.botName,
            botAlias: this.config.botAlias,
            userId: this.sessionId,
            inputText: message
        };
        
        try {
            const response = await this.lexRuntime.postText(params).promise();
            return response.message || '抱歉，我沒有理解您的問題，請您換個方式詢問。';
        } catch (error) {
            console.error('Lex 錯誤:', error);
            throw error;
        }
    }
    
    async getDefaultResponse(message) {
        // 模擬網路延遲
        await this.delay(1000 + Math.random() * 2000);
        
        const lowerMessage = message.toLowerCase();
        
        // 關鍵字匹配回覆
        if (lowerMessage.includes('服務') || lowerMessage.includes('業務') || lowerMessage.includes('什麼')) {
            return 'Ecoshane 提供全方位企業永續發展服務：\n\n🌍 碳足跡評估與減碳策略\n📊 ESG 報告書撰寫與諮詢\n🔄 永續供應鏈管理\n🌱 綠色轉型規劃\n\n您希望了解哪一項服務呢？';
        }
        
        if (lowerMessage.includes('碳') || lowerMessage.includes('減碳') || lowerMessage.includes('溫室氣體')) {
            return '我們的碳管理服務包括：\n\n📋 溫室氣體盤查\n🎯 碳中和路徑規劃\n🌳 碳抵換方案設計\n⚡ 節能減碳技術導入\n\n讓我們協助您制定科學化的減碳策略！';
        }
        
        if (lowerMessage.includes('esg')) {
            return 'ESG 是企業永續經營的關鍵指標：\n\n🌍 環境面 (Environmental)\n• 氣候變遷因應\n• 資源循環利用\n\n👥 社會面 (Social)\n• 員工權益保障\n• 社區共融發展\n\n🏛️ 治理面 (Governance)\n• 透明化資訊揭露\n• 風險管理機制\n\n需要 ESG 評估服務嗎？';
        }
        
        if (lowerMessage.includes('聯繫') || lowerMessage.includes('聯絡') || lowerMessage.includes('電話') || lowerMessage.includes('email')) {
            return '歡迎聯繫 Ecoshane 永續顧問團隊：\n\n📧 電子郵件：contact@ecoshane.com\n📞 電話：+886-9xx-xxx-xxx\n🏢 我們將安排專業顧問為您服務\n\n或者您可以繼續在這裡詢問相關問題！';
        }
        
        if (lowerMessage.includes('價格') || lowerMessage.includes('費用') || lowerMessage.includes('報價')) {
            return '我們的服務費用會根據企業規模和需求客製化報價：\n\n💼 中小企業方案\n🏢 大型企業方案\n📋 單項服務諮詢\n\n建議您聯繫我們安排免費初步諮詢，讓我們了解您的具體需求後提供詳細報價。';
        }
        
        // 預設回覆
        return '感謝您的提問！我是 Ecoshane 的智能助手，專門協助企業永續發展相關諮詢。\n\n您可以詢問我關於：\n• 永續發展服務\n• 碳管理與減碳\n• ESG 報告\n• 聯繫方式\n\n或者直接聯繫我們的專業團隊：contact@ecoshane.com';
    }
    
    addMessage(text, isUser = false, isError = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}${isError ? ' error-message' : ''}`;
        
        // 處理換行
        messageDiv.innerHTML = text.replace(/\n/g, '<br>');
        
        this.chatMessages.appendChild(messageDiv);
        this.scrollToBottom();
        
        // 如果聊天窗口未開啟且是機器人訊息，顯示通知
        if (!this.isOpen && !isUser) {
            this.showNotification();
        }
    }
    
    showTyping() {
        this.isTyping = true;
        this.typingIndicator.classList.add('active');
        this.sendBtn.disabled = true;
        this.scrollToBottom();
    }
    
    hideTyping() {
        this.isTyping = false;
        this.typingIndicator.classList.remove('active');
        this.sendBtn.disabled = false;
    }
    
    clearInput() {
        this.messageInput.value = '';
        this.messageInput.style.height = 'auto';
    }
    
    scrollToBottom() {
        setTimeout(() => {
            this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
        }, 100);
    }
    
    showNotification() {
        this.notificationBadge.classList.add('show');
    }
    
    hideNotification() {
        this.notificationBadge.classList.remove('show');
    }
    
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// 當頁面載入完成後初始化聊天機器人
document.addEventListener('DOMContentLoaded', () => {
    new EcoshaneLexChatbot();
});

// 顯示歡迎通知
setTimeout(() => {
    const badge = document.getElementById('notificationBadge');
    if (badge && !document.querySelector('.ecoshane-chatbot .chat-window.active')) {
        badge.classList.add('show');
    }
}, 2000);
</script>
